  # test the threshold for beginning to use the table
  # test that only 31 'jumps' are shortened
  # test that only jumps requiring 32 bits are shortened
  #   what about if it's already shortened *after* other relaxation
  # test that unrelaxable jumps do not affect the count
  # test that jumps are correctly sorted and most frequent are compressed
  # check that alignment is respected
  # symbols at the same location?

.macro START_NORELAX
  .option push
  .option norelax
.endm

.macro END_NORELAX
  .option pop
.endm

.macro JUMP1 a0
  j \a0
.endm
.macro JUMP2 a0
  JUMP1 \a0 ; JUMP1 \a0
.endm
.macro JUMP3 a0
  JUMP1 \a0 ; JUMP1 \a0 ; JUMP1 \a0
.endm
.macro JUMP8 a0
  JUMP2 \a0 ; JUMP2 \a0 ; JUMP2 \a0 ; JUMP2 \a0
.endm
.macro JUMP32 a0
  JUMP8 \a0 ; JUMP8 \a0 ; JUMP8 \a0 ; JUMP8 \a0
.endm
.macro JUMP128 a0
  JUMP32 \a0 ; JUMP32 \a0 ; JUMP32 \a0 ; JUMP32 \a0
.endm

.macro CALL1 a0
  call \a0
.endm
.macro CALL2 a0
  CALL1 \a0 ; CALL1 \a0
.endm
.macro CALL3 a0
  CALL1 \a0 ; CALL1 \a0 ; CALL1 \a0
.endm
.macro CALL8 a0
  CALL2 \a0 ; CALL2 \a0 ; CALL2 \a0 ; CALL2 \a0
.endm
.macro CALL32 a0
  CALL8 \a0 ; CALL8 \a0 ; CALL8 \a0 ; CALL8 \a0
.endm
.macro CALL128 a0
  CALL8 \a0 ; CALL8 \a0 ; CALL8 \a0 ; CALL8 \a0
.endm

.macro NOP1 a0
  \a0 : nop
.endm

.macro NNOP1 a0, a1, a2, a3, a4, a5, a6, a7
  NOP1 \a0 ; NOP1 \a1 ; NOP1 \a2 ; NOP1 \a3
  NOP1 \a4 ; NOP1 \a5 ; NOP1 \a6 ; NOP1 \a7
.endm
.macro NJUMP3 a0, a1, a2, a3, a4, a5, a6, a7
  JUMP3 \a0 ; JUMP3 \a1 ; JUMP3 \a2 ; JUMP3 \a3
  JUMP3 \a4 ; JUMP3 \a5 ; JUMP3 \a6 ; JUMP3 \a7
.endm
.macro NCALL3 a0, a1, a2, a3, a4, a5, a6, a7
  CALL3 \a0 ; CALL3 \a1 ; CALL3 \a2 ; CALL3 \a3
  CALL3 \a4 ; CALL3 \a5 ; CALL3 \a6 ; CALL3 \a7
.endm

  .text
  .global _start
  .type _start, @function
_start:
  NJUMP3  L0  L1  L2  L3  L4  L5  L6  L7
  NJUMP3  L8  L9 L10 L11 L12 L13 L14 L15
  JUMP2 L16 ; JUMP8 L17 ; JUMP32 L18 ; JUMP128 L19
  JUMP3 L20 ; JUMP3 L21 ; JUMP3 L22 ; JUMP3 L23
  JUMP1 non_cmjt
  NJUMP3 L24 L25 L26 L27 L28 L29 L30 L31

  # lots of unrelaxed jumps should not affect what gets put in the jump table
  START_NORELAX
    JUMP32 non_cmjt
  END_NORELAX

  # add a big gap so that all of the jumps cost the same
  .zero 2048

  NNOP1  L0  L1  L2  L3  L4  L5  L6  L7
  NOP1 non_cmjt
  NNOP1  L8  L9 L10 L11 L12 L13 L14 L15
  NNOP1 L16 L17 L18 L19 L20 L21 L22 L23
  NNOP1 L24 L25 L26 L27 L28 L29 L30 L31
  ret


  .text
  .global apple
  .type apple, @function
apple:
  NCALL3  L32  L33  L34  L35  L36  L37  L38  L39
  NCALL3  L40  L41  L42  L43  L44  L45  L46  L47
  NCALL3  L48  L49  L50  L51  L52  L53  L54  L55
  NCALL3  L56  L57  L58  L59  L60  L61  L62  L63
  NCALL3  L64  L65  L66  L67  L68  L69  L70  L71
  NCALL3  L72  L73  L74  L75  L76  L77  L78  L79
  NCALL3  L80  L81  L82  L83  L84  L85  L86  L87
  NCALL3  L88  L89  L90  L91  L92  L93  L94  L95 
  NCALL3  L96  L97  L98  L99 L100 L101 L102 L103
  CALL1  non_cmjalt
  NCALL3 L104 L105 L106 L107 L108 L109 L110 L111
  NCALL3 L112 L113 L114 L115 L116 L117 L118 L119
  NCALL3 L120 L121 L122 L123 L124 L125 L126 L127
  NCALL3 L128 L129 L130 L131 L132 L133 L134 L135
  NCALL3 L136 L137 L138 L139 L140 L141 L142 L143
  NCALL3 L144 L145 L146 L147 L148 L149 L150 L151
  CALL2 L152 ; CALL8 L153 ; CALL32 L154 ; CALL128 L155
  CALL3 L156 ; CALL3 L157 ; CALL3  L158 ; CALL3   L159
  NCALL3 L160 L161 L162 L163 L164 L165 L166 L167
  NCALL3 L168 L169 L170 L171 L172 L173 L174 L175
  NCALL3 L176 L177 L178 L179 L180 L181 L182 L183
  NCALL3 L184 L185 L186 L187 L188 L189 L190 L191
  NCALL3 L192 L193 L194 L195 L196 L197 L198 L199
  NCALL3 L200 L201 L202 L203 L204 L205 L206 L207
  NCALL3 L208 L209 L210 L211 L212 L213 L214 L215
  NCALL3 L216 L217 L218 L219 L220 L221 L222 L223
  NCALL3 L224 L225 L226 L227 L228 L229 L230 L231
  NCALL3 L232 L233 L234 L235 L236 L237 L238 L239
  NCALL3 L240 L241 L242 L243 L244 L245 L246 L247
  NCALL3 L248 L249 L250 L251 L252 L253 L254 L255

  # lots of unrelaxed calls should not affect what gets put in the jump table
  START_NORELAX
    CALL32 non_cmjalt
  END_NORELAX
  
  # add a gap so that all of the above calls cost the same
  .zero 2048

  NNOP1  L32  L33  L34  L35  L36  L37  L38  L39
  NNOP1  L40  L41  L42  L43  L44  L45  L46  L47
  NNOP1  L48  L49  L50  L51  L52  L53  L54  L55
  NNOP1  L56  L57  L58  L59  L60  L61  L62  L63
  NNOP1  L64  L65  L66  L67  L68  L69  L70  L71
  NNOP1  L72  L73  L74  L75  L76  L77  L78  L79
  NNOP1  L80  L81  L82  L83  L84  L85  L86  L87
  NNOP1  L88  L89  L90  L91  L92  L93  L94  L95 
  NNOP1  L96  L97  L98  L99 L100 L101 L102 L103
  NNOP1 L104 L105 L106 L107 L108 L109 L110 L111
  NNOP1 L112 L113 L114 L115 L116 L117 L118 L119
  NNOP1 L120 L121 L122 L123 L124 L125 L126 L127
  NNOP1 L128 L129 L130 L131 L132 L133 L134 L135
  NNOP1 L136 L137 L138 L139 L140 L141 L142 L143
  NNOP1 L144 L145 L146 L147 L148 L149 L150 L151
  NNOP1 L152 L153 L154 L155 L156 L157 L158 L159
  NNOP1 L160 L161 L162 L163 L164 L165 L166 L167
  NNOP1 L168 L169 L170 L171 L172 L173 L174 L175
  NNOP1 L176 L177 L178 L179 L180 L181 L182 L183
  NNOP1 L184 L185 L186 L187 L188 L189 L190 L191
  NNOP1 L192 L193 L194 L195 L196 L197 L198 L199
  NNOP1 L200 L201 L202 L203 L204 L205 L206 L207
  NNOP1 L208 L209 L210 L211 L212 L213 L214 L215
  NNOP1 L216 L217 L218 L219 L220 L221 L222 L223
  NNOP1 L224 L225 L226 L227 L228 L229 L230 L231
  NNOP1 L232 L233 L234 L235 L236 L237 L238 L239
  NOP1 non_cmjalt
  NNOP1 L240 L241 L242 L243 L244 L245 L246 L247
  NNOP1 L248 L249 L250 L251 L252 L253 L254 L255
  ret
